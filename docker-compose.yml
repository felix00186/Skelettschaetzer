version: '3.8'

x-gpu: &gpu
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

x-depends: &depends-on-video-loader
  depends_on:
    input-loader:
      condition: service_completed_successfully

x-volume: &input-volume
  volumes:
    - ${INPUT_FOLDER}:/data


services:

  # Vorbereitung
  input-loader:             # == Youtube-Downloader ==
    build: ./input-loader   # laedt ein YouTube-Video von einer gegebenen URL herunter,
    restart: "no"           # falls kein mp4-Video gegeben ist.
    <<: *input-volume       # Ausfuehrung vor den Skelettschaetzern.

  # Nachbereitung
  codecs:
    build: ./codecs
    restart: "no"
    <<: *input-volume
    depends_on:
      blazepose:
        condition: service_completed_successfully
      lightweight:
        condition: service_completed_successfully
      deeppose:
        condition: service_completed_successfully
      densepose:
        condition: service_completed_successfully
      tfpose:
        condition: service_completed_successfully
      higher-hrnet:
        condition: service_completed_successfully


  # Skelettschaetzer
  blazepose:
    build: ./pose/blazepose
    restart: "no"
    <<: [*depends-on-video-loader, *input-volume]

  lightweight:
    build: ./pose/lightweight
    restart: "no"
    <<: [*gpu, *depends-on-video-loader, *input-volume]

  densepose:
    build: ./pose/densepose
    restart: "no"
    <<: [*gpu, *depends-on-video-loader, *input-volume]

  tfpose:
    build: ./pose/tfpose
    restart: "no"
    <<: [*gpu, *depends-on-video-loader, *input-volume]

  higher-hrnet:
    build: ./pose/hrnet
    restart: "no"
    <<: [*gpu, *depends-on-video-loader, *input-volume]

  deeppose:
    build: ./pose/deeppose
    restart: "no"
    <<: [*gpu, *depends-on-video-loader, *input-volume]
